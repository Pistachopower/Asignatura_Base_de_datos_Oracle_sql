-- Realiza una vista que muestre los datos de un empleado 
-- (nombre, apellidos, ciudad de la oficina) 
-- y lo mismo para su jefe (en la misma fila)
-- y del jefe de su jefe
SELECT E.NOMBRE, O.CIUDAD,J.NOMBRE, OJ.CIUDAD, JJ.NOMBRE, OJJ.CIUDAD
FROM EMPLEADOS E, OFICINAS O, EMPLEADOS J, OFICINAS OJ,EMPLEADOS JJ, OFICINAS OJJ
WHERE E.CODIGOOFICINA = O.CODIGOOFICINA
AND J.CODIGOOFICINA = OJ.CODIGOOFICINA
AND E.CODIGOJEFE = J.CODIGOEMPLEADO
AND JJ.CODIGOOFICINA = OJJ.CODIGOOFICINA
AND J.CODIGOJEFE = JJ.CODIGOEMPLEADO;

--
SELECT E.NOMBRE, O.CIUDAD, LEVEL
FROM EMPLEADOS E, OFICINAS O
WHERE E.CODIGOOFICINA = O.CODIGOOFICINA
AND LEVEL <=3
CONNECT BY PRIOR E.CODIGOJEFE = e.codigoempleado;


SELECT E.NOMBRE, O.CIUDAD,J.NOMBRE, OJ.CIUDAD
FROM EMPLEADOS E, OFICINAS O, EMPLEADOS J,OFICINAS OJ
WHERE E.CODIGOOFICINA = O.CODIGOOFICINA
AND E.CODIGOJEFE = J.CODIGOEMPLEADO
AND J.CODIGOOFICINA=OJ.CODIGOOFICINA;

INSERT INTO oficinas 
(codigooficina,ciudad,pais,region, codigopostal, telefono, lineadireccion1, lineadireccion2)
VALUES ('SVQ-42', 'SEVILLA','ESPAÑA', NULL,41013,666555444, 'C/Esclava del señor 2', null);


DELETE
FROM OFICINAS
WHERE CODIGOOFICINA NOT IN (SELECT DISTINCT CODIGOOFICINA FROM EMPLEADOS);


--61 Devuelve el nombre del producto del que se han vendido 
-- más unidades. 
-- (Tenga en cuenta que tendrá que calcular cuál es el 
-- número total de unidades que se han vendido de 
-- cada producto a partir de los datos de la tabla detalle_pedido)
SELECT DP.CODIGOPRODUCTO, SUM(DP.CANTIDAD)
FROM DETALLEPEDIDOS DP 
GROUP BY DP.CODIGOPRODUCTO
HAVING SUM(DP.CANTIDAD) = (SELECT MAX(SUM(DP.CANTIDAD)) 
                    FROM DETALLEPEDIDOS DP
                    GROUP BY DP.CODIGOPRODUCTO);

SELECT * FROM (
                SELECT CODIGOPRODUCTO, SUM(CANTIDAD)
                FROM DETALLEPEDIDOS
                GROUP BY CODIGOPRODUCTO
                ORDER BY SUM(CANTIDAD) DESC)
WHERE ROWNUM = 1;


-- ACTUALIZAR EL PRECIO DE VENTA DEL PRODUCTO 
-- AL PRECIO MEDIO AL CUAL HE VENDIDO FR-67
SELECT AVG(DP.PRECIOUNIDAD)--SUM(DP.CANTIDAD*DP.PRECIOUNIDAD)/SUM(DP.CANTIDAD)
FROM DETALLEPEDIDOS DP
WHERE UPPER(DP.codigoproducto) = 'FR-67';

UPDATE PRODUCTOS PR
SET pr.precioventa = (SELECT SUM(DP.CANTIDAD*DP.PRECIOUNIDAD)/SUM(DP.CANTIDAD)
                      FROM DETALLEPEDIDOS DP
                      WHERE UPPER(DP.codigoproducto) = PR.CODIGOPRODUCTO
                      )
WHERE PR.CODIGOPRODUCTO IN (SELECT DP.CODIGOPRODUCTO FROM DETALLEPEDIDOS DP);


SELECT CODIGOPRODUCTO, NOMBRE, PRECIOVENTA
FROM PRODUCTOS 
WHERE CODIGOPRODUCTO NOT IN (SELECT DP.CODIGOPRODUCTO FROM DETALLEPEDIDOS DP);


SELECT DP.CODIGOPRODUCTO,AVG(DP.PRECIOUNIDAD) AS RAUL, SUM(DP.CANTIDAD*DP.PRECIOUNIDAD)/SUM(DP.CANTIDAD) AS ANTONIO
FROM DETALLEPEDIDOS DP
GROUP BY DP.CODIGOPRODUCTO;
